<html class="a-fullscreen" data-lt-installed="true">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<title>Location-based AR.js demo</title>
		<meta
			aframe-injected=""
			name="viewport"
			content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no,user-scalable=no,minimal-ui,viewport-fit=cover"
		/>
		<meta aframe-injected="" name="mobile-web-app-capable" content="yes" />
		<meta aframe-injected="" name="theme-color" content="black" />
		<script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>

		<script
			type="text/javascript"
			src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"
		></script>
		<script
			type="text/javascript"
			src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"
		></script>
		<script>
			// Component to handle each POI: look-at the camera, update distance and update size
			AFRAME.registerComponent("poi", {
				schema: {
					distText: { type: "string", default: "poi" },
				},

				_cam3D: null,
				_pos: null,
				_posCam3D: null,

				init: function () {
					this._cam3D = document.querySelector("a-camera").object3D;
					this._pos = new THREE.Vector3();
					this._posCam3D = new THREE.Vector3();
				},

				tick: function () {
					// Update camera position
					this._cam3D.getWorldPosition(this._posCam3D);

					// Update current position
					const el = this.el.object3D;
					el.getWorldPosition(this._pos);

					// LookAt the camera
					el.lookAt(this._posCam3D.x, this._pos.y, this._posCam3D.z);

					// Update distance text
					const textDist = document.getElementById(
						this.data.distText
					);
					const dist = this._pos.distanceTo(this._posCam3D);
					textDist.setAttribute(
						"value",
						"" + parseFloat(dist).toFixed(2) + " m."
					);

					// Compute size
					this.el.setAttribute("scale", {
						x: dist * 0.01,
						y: dist * 0.01,
						z: dist * 0.01,
					});
				},
			});

			// Component to create POIs
			AFRAME.registerComponent("load-pois", {
				loadedPois: false,

				init: function () {
					// Register GPS position listener
					const el = document.querySelector("[gps-new-camera]");
					el.addEventListener("gps-camera-update-position", (e) => {
						console.log(
							"new camera position " +
								e.detail.position.latitude +
								", " +
								e.detail.position.longitude
						);
						if (this.loadedPois == false) {
							this.getPOIS(
								e.detail.position.latitude,
								e.detail.position.longitude
							);
						}
					});
				},

				getPOIS: async function (lat, long) {
					/* 
					const dist = 0.01;
					const west = long - dist;
					const east = long + dist;
					const south = lat - dist;
					const north = lat + dist; 
					*/

					// Download pois data from open street maps
					const res = await fetch(
						`https://valencia.opendatasoft.com/api/records/1.0/search/?dataset=valenbisi-disponibilitat-valenbisi-dsiponibilidad&q=&geofilter.distance=${lat},${long},1000`
					);

					const pois = await res.json();

					pois.records.map((feature, index) => {
						if (!feature.properties.hasOwnProperty("address")) {
							return;
						}

						const poi = document.createElement("a-entity");

						poi.setAttribute("gps-new-entity-place", {
							latitude: feature.geo_shape.coordinates[1],
							longitude: feature.geo_shape.coordinates[0],
						});
						const tam = 3;
						const id = "POI_" + index;
						poi.setAttribute("id", id);
						poi.setAttribute("scale", {
							x: tam,
							y: tam,
							z: tam,
						});

						poi.setAttribute("poi", "distText:" + id + "_distText");

						// Add geometry: sign post
						const post = document.createElement("a-box");
						post.setAttribute("scale", {
							x: 2,
							y: 5,
							z: 2,
						});
						post.setAttribute("position", {
							x: 0,
							y: 2.5,
							z: 0,
						});
						post.setAttribute("material", {
							color: "red",
						});

						poi.appendChild(post);

						// Add geometry: sign background
						const back = document.createElement("a-box");
						back.setAttribute("scale", {
							x: 25,
							y: 6,
							z: 2,
						});
						back.setAttribute("position", {
							x: 0,
							y: 8,
							z: 0,
						});
						back.setAttribute("material", {
							color: "red",
						});
						poi.appendChild(back);

						// Add text
						const text_name = document.createElement("a-text");
						text_available.setAttribute("id", id + "_text_name");
						text_name.setAttribute("position", {
							x: 0,
							y: 9,
							z: 3,
						});
						text_name.setAttribute("value", feature.address);
						text_name.setAttribute("align", "center");
						text_name.setAttribute("width", 40);
						text_name.setAttribute("wrapcount", 20);
						poi.appendChild(text_name);
						//////////////////////////////////////////////////
						const text_available = document.createElement("a-text");
						text_available.setAttribute(
							"id",
							id + "_text_available"
						);
						text_available.setAttribute("position", {
							x: 0,
							y: 7,
							z: 3,
						});
						text_available.setAttribute(
							"value",
							"Bicis disponibles" + feature.available
						);
						text_available.setAttribute("align", "center");
						text_available.setAttribute("width", 40);
						text_available.setAttribute("wrapcount", 20);
						poi.appendChild(text_available);
						//////////////////////////////////////////////////
						const text_free = document.createElement("a-text");
						text_free.setAttribute("id", id + "_text_free");
						text_free.setAttribute("position", {
							x: 0,
							y: 7,
							z: 3,
						});
						text_free.setAttribute(
							"value",
							"Huecos libres" + feature.free
						);
						text_free.setAttribute("align", "center");
						text_free.setAttribute("width", 40);
						text_free.setAttribute("wrapcount", 20);
						poi.appendChild(text_free);
						//////////////////////////////////////////////////
						this.el.appendChild(poi);
					});

					console.log("loaded " + pois.records.length() + " POIs");
					this.loadedPois = true;
				},
			});
		</script>
	</head>

	<body>
		<a-scene
			vr-mode-ui="enabled: false"
			arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: true"
			renderer="antialias: true; alpha: true"
			inspector=""
			keyboard-shortcuts=""
			screenshot=""
			device-orientation-permission-ui=""
		>
			<!-- For debug Centro Valencia -->
			<!-- <a-camera id="gps-new-camera" gps-new-camera='gpsMinDistance: 5; simulateLatitude: 39.47402866521183; simulateLongitude: -0.3762567909771192' camera="far:1000000;"></a-camera> -->

			<a-camera
				id="gps-new-camera"
				gps-new-camera="gpsMinDistance: 5"
				camera="far:10000;"
				position=""
				rotation=""
				look-controls=""
				wasd-controls=""
				look-controls-enabled="true"
			></a-camera>

			<!-- Plaza del ayuntamiento de Valencia -->
			<a-entity
				material="color: red"
				geometry="primitive: box"
				gps-entity-place="latitude: 39.470021834872675; longitude: -0.37635147292514465"
				scale="100 100 100"
			></a-entity>

			<!-- Load POIs -->
			<a-entity id="POIS" load-pois=""> </a-entity>

			<canvas
				class="a-canvas a-grab-cursor"
				data-aframe-canvas="true"
				width="1202"
				height="893"
				style=""
			></canvas>
			<div class="a-loader-title" style="display: none">
				Location-based AR.js demo
			</div>
			<a-entity arjs-webcam-texture=""></a-entity
			><a-entity
				light=""
				data-aframe-default-light=""
				aframe-injected=""
			></a-entity
			><a-entity
				light=""
				position=""
				data-aframe-default-light=""
				aframe-injected=""
			></a-entity
		></a-scene>

		<video autoplay="true" playsinline="true" display="none"></video>
	</body>
</html>
